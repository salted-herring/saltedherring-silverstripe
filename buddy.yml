- pipeline: "saltedherring.design SilverStripe"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "master"
  ref_type: "BRANCH"
  target_site_url: "https://api.saltedherring.design/"
  trigger_condition: "ALWAYS"
  actions:
  - action: "Execute: archive site"
    type: "BUILD"
    working_directory: "/buddy/saltedherring.design"
    docker_image_name: "simonwinter/silverstripe_lamp_nz"
    docker_image_tag: "4.0"
    execute_commands:
    - "if [ ! -d ./archives ]"
    - "then"
    - "\tmkdir ./archives"
    - "fi"
    - "if [ -d  /buddy/saltedherring.design/vendor/silverstripe/graphql ]"
    - "then"
    - "\trm -rf /buddy/saltedherring.design/vendor/silverstripe/graphql"
    - "fi"
    - "composer update --optimize-autoloader"
    - "# once composer update is complete, we need to overwrite the existing GrpahlQL controller:"
    - "if [ -f ./vendor/silverstripe/graphql/src/Controller.php ]"
    - "then"
    - "\tcp -rfp ./overwrites/Controller.php ./vendor/silverstripe/graphql/src/Controller.php"
    - "fi"
    - "# remove oldest archive if we have more than 6"
    - "count=$(ls -1tr ./archives | wc -l)"
    - "if [ $count \\> 6 ] "
    - "then"
    - "\toldest=$(ls -1tr archives | head -n 1)"
    - "\tif [ -f ./archives/$oldest ]"
    - "\tthen"
    - "\t\trm ./archives/$oldest"
    - "\tfi"
    - "fi"
    - "# archive the site"
    - "tar --exclude=archives --exclude=.git* --exclude=.env* --exclude=editorconfig -zvcf archives/deployment-${execution.id}.tgz ."
    mount_filesystem_path: "/buddy/saltedherring.design"
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "Rsync to 120.138.18.50"
    type: "RSYNC"
    local_path: "archives/"
    remote_path: "~/container/application/archives"
    login: "saltydesign"
    host: "120.138.18.50"
    port: "22"
    env_key: "secure!lC7WtI31Zd39h8CmPk8NbQ=="
    authentication_mode: "ENV_KEY"
    archive: true
    delete_extra_files: true
    compress: true
    deployment_excludes:
    - "/.git/"
    trigger_condition: "ALWAYS"
  - action: "[120.138.18.50] Execute: unarchive latest"
    type: "SSH_COMMAND"
    login: "saltydesign"
    host: "120.138.18.50"
    port: "22"
    env_key: "secure!lC7WtI31Zd39h8CmPk8NbQ=="
    authentication_mode: "ENV_KEY"
    commands:
    - "cd ~/container/application"
    - "latest=$(ls -1t archives | head -n 1)"
    - "if [ ! -d release ]"
    - "then"
    - "\tmkdir release"
    - "else"
    - "\trm -rf release"
    - "\tmkdir release"
    - "fi"
    - "tar -xzvf archives/$latest -C ~/container/application/release"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "[120.138.18.50] Execute: symlink internal folders"
    type: "SSH_COMMAND"
    login: "saltydesign"
    host: "120.138.18.50"
    port: "22"
    env_key: "secure!lC7WtI31Zd39h8CmPk8NbQ=="
    authentication_mode: "ENV_KEY"
    commands:
    - "if [ ! -d ~/container/application/release ]"
    - "then"
    - "\texit 0"
    - "fi"
    - "cd ~/container/application/release/public"
    - "if [ -d ./assets ]"
    - "then"
    - "\trm -rf ./assets"
    - "fi"
    - "ln -snf /var/www/html/shared/assets"
    - "ln -snf /var/www/html/shared/silverstripe-cache"
    - "cd ~/container/application/release"
    - "ln -snf /var/www/html/shared/robots.txt"
    - "ln -snf /var/www/html/shared/.env"
    - "cd ~/container/application/release/app/_config"
    - "ln -snf /var/www/html/shared/_config/live.yml"
    - "#ln -snf /var/www/html/shared/silverstripe.log"
    - "# cd ~/container/application/release/app/_config/"
    - "# ln -snf /var/www/html/shared/_config/images.yml"
    - "# if [ -f ~/container/application/release/app/_config/search-server.yml ]"
    - "# then"
    - "# \trm -f ~/container/application/release/app/_config/search-server.yml"
    - "# fi"
    - "# ln -snf /var/www/html/shared/_config/search-server.yml"
    - "# ln -snf /var/www/html/shared/_config/live-site.yml"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "[120.138.18.50] Execute: sake dev/build flush=all"
    type: "SSH_COMMAND"
    login: "saltydesign"
    host: "120.138.18.50"
    port: "22"
    env_key: "secure!lC7WtI31Zd39h8CmPk8NbQ=="
    authentication_mode: "ENV_KEY"
    commands:
    - "if [ ! -d ~/container/application/release ]"
    - "then"
    - "\texit 0"
    - "fi"
    - "cd ~/container/application/release"
    - "composer update --optimize-autoloader"
    - "php vendor/silverstripe/framework/cli-script.php dev/build flush=all"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "[120.138.18.50] Execute: move release"
    type: "SSH_COMMAND"
    login: "saltydesign"
    host: "120.138.18.50"
    port: "22"
    env_key: "secure!lC7WtI31Zd39h8CmPk8NbQ=="
    authentication_mode: "ENV_KEY"
    commands:
    - "if [ ! -d ~/container/application/release ]"
    - "then"
    - "\texit 0"
    - "fi"
    - "cd ~/container/application"
    - "mv release releases/${execution.id}"
    - "rm -rf public"
    - "ln -s releases/${execution.id} public"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "Execute: clean up"
    type: "SSH_COMMAND"
    login: "saltydesign"
    host: "120.138.18.50"
    port: "22"
    env_key: "secure!lC7WtI31Zd39h8CmPk8NbQ=="
    authentication_mode: "ENV_KEY"
    commands:
    - "# remove old releases - i.e. more than 6."
    - "cd ~/container/application"
    - "count=$(ls -1tr ~/container/application/releases | wc -l)"
    - "if [ $count \\> 6 ] "
    - "then"
    - "\toldest=$(ls -1tr ~/container/application/releases | head -n 1)"
    - "\tif [ -d ~/container/application/releases/$oldest ]"
    - "\tthen"
    - "\t\trm -rf ~/container/application/releases/$oldest"
    - "\tfi"
    - "fi"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "Send notification to buddy channel"
    type: "SLACK"
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    channel: "G5M1EEKFX"
    channel_name: "buddy"
    attachments:
    - "{\"fallback\":\"$BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID\",\"color\":\"good\",\"fields\":[{\"title\":\"Successful execution\",\"value\":\"<$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\",\"short\":true},{\"title\":\"Branch\",\"value\":\"$BUDDY_EXECUTION_BRANCH\",\"short\":true},{\"title\":\"Project\",\"value\":\"<$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\",\"short\":true}]}"
    trigger_condition: "ALWAYS"
    integration_id: 2
  - action: "Send notification to buddy channel"
    type: "SLACK"
    trigger_time: "ON_FAILURE"
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    channel: "G5M1EEKFX"
    channel_name: "buddy"
    attachments:
    - "{\"fallback\":\"$BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID\",\"color\":\"danger\",\"fields\":[{\"title\":\"Failed execution\",\"value\":\"<$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\",\"short\":true},{\"title\":\"Branch\",\"value\":\"$BUDDY_EXECUTION_BRANCH\",\"short\":true},{\"title\":\"Project\",\"value\":\"<$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\",\"short\":true}]}"
    trigger_condition: "ALWAYS"
    integration_id: 2
